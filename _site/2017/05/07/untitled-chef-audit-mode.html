<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Chef audit mode</title>
  <meta name="description" content="I have spoken before about how important it is for me and my team to make as many parts of the database stack match our larger infrastructure. One of the most crucial ways to do this is to make sur..." />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@dirkfabisch" />
    <meta name="twitter:title" content="Chef audit mode" />
    <meta name="twitter:image" content="http://localhost:4000/assets/images/unicorn_av.png" />
    
    <meta name="twitter:description"  content="I have spoken before about how important it is for me and my team to make as many parts of the database stack match our larger infrastructure. One of the most crucial ways to do this is to make sur..." />
    
  
  
  <meta property="og:site_name" content="Mediator" />
  <meta property="og:title" content="Chef audit mode"/>
  
  <meta property="og:description" content="I have spoken before about how important it is for me and my team to make as many parts of the database stack match our larger infrastructure. One of the most crucial ways to do this is to make sur..." />
  
  <meta property="og:image" content="http://localhost:4000/assets/images/unicorn_av.png" />
  <meta property="og:url" content="http://localhost:4000/2017/05/07/untitled-chef-audit-mode.html" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2017-05-07T20:49:11-07:00">

  <link rel="canonical" href="http://localhost:4000/2017/05/07/untitled-chef-audit-mode.html"/>
  <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/png"/>
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>

</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<!-- header start -->


  <a href="http://localhost:4000" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/unicorn_av.png)"></span></a>

<!-- header end -->


<div id="main" role="main">
  <article class="hentry hentry-dark">
    <div class="entry-content">
      
      <h1 class="post-title entry-title">Chef audit mode</h1>
      <p>I have spoken before about how important it is for me and my team to make as many parts of the database stack match our larger infrastructure. One of the most crucial ways to do this is to make sure that not only are we deploying and managing databases using configuraton management, but that the cookbooks remain in lock step with changes our cookbooks at large move towards.</p>

<p>When i first learned chef, the way to test your chef cookbooks was <a href="https://github.com/chef/minitest-chef-handler">chef minitest</a>. But that is <a href="https://github.com/chef/minitest-chef-handler/blob/master/README.md#deprecation-notice">now deprecated</a> and is no longer the recommended test method of chef cookbooks. So what is a DBA who is not always in tune with chef land to do? learn from her teammates of course! ðŸ˜€</p>

<p>With the help of our ops engineering team members, I was directed at some examples in newer cookbooks we have and to the resources supported by InSpec which is what chef-audit is based on.</p>

<p><em>So how does chef audit mode work?</em></p>

<p>Chef audit works exactly like recipe code. In fact, you can write the audit code right inside the recipe it is auditing. It is very natural in its language which makes it very easy to write <em>before</em> the actual chef code (hint hint: TDD FTW!) and it has lots of <a href="http://serverspec.org/resource_types.html">resource types</a> which make for simple, easy to read and maintain, tests.</p>

<p><em>So if I have a cookbook that was using minitest, how can I make it move to chef audit?</em></p>

<p>You need to decide where your audit code will live. Your options are:</p>

<ul>
  <li>
    <p>One gigantic audit recipe that is included in your runlist however you normally include recipes in the cookbook. This option will put all the code in one file but can get unwieldy and large as a cookbook gets more complex</p>
  </li>
  <li>
    <p>An <code class="highlighter-rouge">_audit_foo.rb</code> recipe for every <code class="highlighter-rouge">foo.rb</code> recipe you already have. The audit ones have to be separately included as well. This is arguably the most organized manner to do this and can work very well for books with lots of internal recipes where one large audit file can get very large. But it can also feel like recipe sprawl.</p>
  </li>
  <li>
    <p>Add the audit code directly inside each recipe. This is nice because you can then see in the same file both the code that makes the changes and the audits that run to validate the policies around these changes. But again, this can get harder to use if the individual recipe is long or complex</p>
  </li>
</ul>

<p>Each of these, as you can see, have pros and cons. The good thing about this flexibility is that you can pick what works best for your cookbook or organization :D</p>

<p>Now onto an exampleâ€¦or twoâ€¦</p>

<p>Say you have this code block in a recipe to drop a script file in a specific spot and make it executable.</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cookbook_file</span> <span class="s1">'/usr/local/bin/test_backup.sh'</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'test_backup.sh'</span>
  <span class="n">owner</span> <span class="s1">'mysql'</span>
  <span class="n">group</span> <span class="s1">'mysql'</span>
  <span class="n">mode</span> <span class="mi">0</span><span class="n">o755</span>
  <span class="n">action</span> <span class="ss">:create</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The code to audit this block would look like this</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">control_group</span> <span class="s1">'MySQL BackupTests : Archive access'</span> <span class="k">do</span>
  <span class="n">control</span> <span class="s1">'test_backup.sh'</span> <span class="k">do</span>
      <span class="n">describe</span> <span class="n">file</span><span class="p">(</span><span class="s1">'/usr/local/bin/test_backup.sh'</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">exist</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_file</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_executable</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_owned_by</span> <span class="s1">'mysql'</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As you can see, the audit part is very natural in its language, and the resources are quite simple to use. So how do we tell chef to run this audit code in our test environment?</p>

<p>Presuming you use test kitchen, you need to edit that config to enable audit mode.
Under the provisioner section of your <code class="highlighter-rouge">.kitchen.yml</code> config file, add these 2 lines:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>client_rb:
  audit_mode: :enabled
</code></pre></div></div>

<p>So what are the advantages of audit_mode vs the old minitests? well besides the fact that minitest is deprecated, I find that having the test code as part of the recipe tree (and better yet, can even be <em>in</em> the recipe directly) gives a very nice single view of what every recipe should look like and what my view of the state of the host should be based on that. That should come even handier for anyone trying to look at a cookbook I wrote and understand what the cookbook is supposed to do.</p>

<p>Aa I started a journey with chef <a href="https://dbsmasher.com/2015/02/12/-learning-configuration-management-as-a-dba/">a few years back</a>, converting my knowledge on how to build our databases into repeatable cookbooks, I will be spending the next months with the rest of our data ops team converting our resources into chef audit code.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://localhost:4000/tags#infra_as_code" title="Pages tagged infra_as_code" class="tag"><span class="term">infra_as_code</span></a></span>
        
        <span class="author vcard"><span class="fn"></span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2017/05/07/untitled-chef-audit-mode.html" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2017/05/07/untitled-chef-audit-mode.html" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://localhost:4000/2017/05/07/untitled-chef-audit-mode.html" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->

      </footer>
    </div><!-- /.entry-content -->
    <div class="read-more">
  <div class="read-more-header">
    <a href="" class="read-more-btn">About the Author</a>
  </div><!-- /.read-more-header -->
  <div class="read-more-content author-info">
    <h3></h3>
    <div class="author-container">
      <img class="author-img" src="http://localhost:4000/" alt="" />
      <div class="author-bio"></div>
    </div>
    <div class="author-share">
      <ul class="list-inline social-buttons">
        
          <li><a href="https://twitter.com/dbsmasher" target="_blank"><i class="fa fa- fa-fw"></i></a></li>
        
          <li><a href="https://github.com/silviabotros" target="_blank"><i class="fa fa- fa-fw"></i></a></li>
        
      </ul>
      
      <br>
      
    </div>
  </div>
</div>

    
    
  </article>
</div><!-- /#main -->

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="http://localhost:4000/assets/js/scripts.min.js"></script>
<script type="text/javascript" async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>










<div class="footer-wrapper">
  <footer role="contentinfo">
    <!-- footer start -->

<footer class="site-footer">
  <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> Subscribe!</span></a>
    <div class="inner">
         <section class="copyright">All content copyright <a href="mailto:a-mail@mail.mail">Dirk Fabisch</a> &copy; 2018 &bull; All rights reserved.</section>
         <section class="poweredby">Made with <a href="http://jekyllrb.com"> Jekyll</a></section>
    </div>
</footer>

<!-- footer end -->

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
